<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASE Protocol Airdrop Allocation Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Dark background for professional look */
        }
        .container-bg {
            background-color: #121212;
        }
        .text-base-blue {
            color: #0052FF; /* BASE Blue */
        }
        .btn-primary {
            background-color: #0052FF;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #003ECC;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 82, 255, 0.4);
        }
        .input-text {
            border: 2px solid #333;
            background-color: #1F1F1F;
            color: white;
            transition: border-color 0.2s;
        }
        .input-text:focus {
            border-color: #0052FF;
            outline: none;
        }
        .result-box {
            border-radius: 1rem;
            border: 2px solid #0052FF;
            background-color: #0a0a0a;
            box-shadow: 0 0 20px rgba(0, 82, 255, 0.2);
        }
    </style>

    <!-- Farcaster Frame Meta Tags (Using Vercel URL for stability) -->
    <!-- This is the key to making the Frame appear. -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://placehold.co/1200x630/0052FF/ffffff?text=BASE+x+ETH+Airdrop+Checker" />
    <meta property="fc:frame:button:1" content="Check Allocation Now" />
    <meta property="fc:frame:post_url" content="https://base-checker-airdrop.vercel.app/" />
    <!-- End Farcaster Frame Meta Tags -->
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="container-bg w-full max-w-lg mx-auto p-6 md:p-10 rounded-xl shadow-2xl border border-gray-800">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2">
                <span class="text-base-blue">BASE</span> Protocol Airdrop
            </h1>
            <p class="text-gray-400 text-lg">Allocation Portal</p>
        </header>

        <main>
            <div class="mb-6">
                <label for="walletAddress" class="block text-sm font-medium text-gray-300 mb-2">
                    Enter your ETH / BASE Wallet Address (0x...)
                </label>
                <input type="text" id="walletAddress" placeholder="E.g., 0xAb5801..." class="input-text w-full p-3 rounded-lg text-lg focus:ring-2 focus:ring-base-blue" maxlength="42">
                <p id="addressError" class="text-red-500 text-sm mt-1 h-5"></p>
            </div>

            <button onclick="checkAirdrop()" id="checkButton" class="btn-primary w-full text-white font-bold py-3 rounded-lg text-xl tracking-wider">
                Verify & Check Allocation
            </button>

            <div id="loadingIndicator" class="mt-6 text-center hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-base-blue border-t-transparent rounded-full"></div>
                <p class="text-gray-400 mt-2">Verifying on-chain interactions...</p>
            </div>

            <!-- Result Box -->
            <div id="resultContainer" class="mt-8 result-box p-6 hidden">
                <h2 class="text-xl font-bold mb-3 text-white">Verification Status:</h2>
                <p id="eligibilityStatus" class="text-2xl font-extrabold mb-4"></p>
                <div id="allocationDetails" class="space-y-1 text-gray-300 border-t border-gray-700 pt-3">
                    <p>Allocated Tokens: <span id="allocatedAmount" class="font-bold text-lg text-base-blue ml-1"></span></p>
                    <p>Claim Method: <span class="font-bold text-green-400">Smart Contract Claim (TBD)</span></p>
                    <p class="text-sm text-gray-500 mt-3">Note: This data is simulated and consistent per wallet address.</p>
                </div>

                <!-- LLM Features -->
                <div class="mt-6 space-y-3">
                    <button onclick="analyzeDefiProfile()" id="analyzeButton" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-600 transition duration-150">
                        <span>✨ Analyze DeFi Profile (Powered by Gemini AI)</span>
                    </button>
                    <button onclick="draftClaimLetter()" id="draftButton" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-600 transition duration-150">
                        <span>✉️ Draft Claim Letter (Powered by Gemini AI)</span>
                    </button>
                </div>

                <!-- LLM Output -->
                <div id="llmOutput" class="mt-6 p-4 bg-gray-800 rounded-lg text-sm text-gray-200 hidden">
                    <h3 class="font-bold mb-2 text-base-blue">AI Analysis Result:</h3>
                    <div id="llmText"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; // Provided by Canvas
        const TOKEN_SYMBOL = "$BASE";

        // Utility function to generate a consistent hash code from a string
        function hashCode(s) {
            let hash = 0;
            for (let i = 0; i < s.length; i++) {
                const char = s.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // Main function to verify and display allocation
        function checkAirdrop() {
            const addressInput = document.getElementById('walletAddress');
            const address = addressInput.value.trim();
            const errorElement = document.getElementById('addressError');
            const resultContainer = document.getElementById('resultContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const eligibilityStatus = document.getElementById('eligibilityStatus');
            const allocatedAmount = document.getElementById('allocatedAmount');
            const llmOutput = document.getElementById('llmOutput');

            // Reset UI
            resultContainer.classList.add('hidden');
            llmOutput.classList.add('hidden');
            errorElement.textContent = '';
            document.getElementById('llmText').innerHTML = '';

            // Validation for wallet address format
            if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
                errorElement.textContent = 'Invalid address format. Must start with 0x and be 42 characters long.';
                return;
            }

            // Show loading
            loadingIndicator.classList.remove('hidden');
            document.getElementById('checkButton').disabled = true;

            // Simulated delay
            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                document.getElementById('checkButton').disabled = false;

                // 1. Determine eligibility (Always eligible per user request)
                const isEligible = true;

                // 2. Calculate Consistent Fictional Allocation
                const baseHash = hashCode(address);
                const allocationBase = 5000;
                const allocationBonus = (baseHash % 1000) * 10; // Bonus up to 10,000 tokens
                const finalAllocation = allocationBase + allocationBonus;

                if (isEligible) {
                    eligibilityStatus.textContent = 'ELIGIBILITY CONFIRMED (Level A)';
                    eligibilityStatus.classList.remove('text-red-500');
                    eligibilityStatus.classList.add('text-green-500');

                    allocatedAmount.textContent = `${finalAllocation.toLocaleString('en-US')} ${TOKEN_SYMBOL}`;
                }

                resultContainer.classList.remove('hidden');
            }, 1500);
        }

        // Function to call Gemini API
        async function callGemini(systemPrompt, userQuery, outputElementId, buttonId) {
            const outputElement = document.getElementById(outputElementId);
            const button = document.getElementById(buttonId);
            const llmOutputContainer = document.getElementById('llmOutput');

            button.disabled = true;
            button.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Loading...';
            outputElement.innerHTML = '';
            llmOutputContainer.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const url = `${API_URL}${apiKey}`;

            try {
                // Implement exponential backoff
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error('Failed to connect to API after multiple retries.');
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to get response from AI.";
                outputElement.innerHTML = formatLLMText(text);

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputElement.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                button.disabled = false;
                if (buttonId === 'analyzeButton') {
                    button.innerHTML = '<span>✨ Analyze DeFi Profile (Powered by Gemini AI)</span>';
                } else if (buttonId === 'draftButton') {
                    button.innerHTML = '<span>✉️ Draft Claim Letter (Powered by Gemini AI)</span>';
                }
            }
        }

        // Utility function to format LLM text (e.g., convert newlines to paragraphs)
        function formatLLMText(text) {
            // Replace double newlines with paragraph tags
            return text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')
                       .replace(/(\*+)(.*?)\1/g, '<strong>$2</strong>'); // Simple bold formatting
        }

        // Feature 1: DeFi Profile Analysis (Simulated)
        function analyzeDefiProfile() {
            const address = document.getElementById('walletAddress').value.trim();
            const allocated = document.getElementById('allocatedAmount').textContent;

            const systemPrompt = `You are a highly experienced and professional on-chain analyst. Your task is to analyze the provided Ethereum/BASE wallet address. Provide a convincing, fictional summary of the address's DeFi activity in one professional paragraph. Focus on fictional interactions with BASE swaps, bridges, or governance. Do not mention that this is fictional.`;
            
            const userQuery = `Based on the ${allocated} token allocation, analyze the DeFi profile for this address: ${address}.`;

            callGemini(systemPrompt, userQuery, 'llmText', 'analyzeButton');
        }

        // Feature 2: Draft Claim Letter (Simulated)
        function draftClaimLetter() {
            const address = document.getElementById('walletAddress').value.trim();
            const allocated = document.getElementById('allocatedAmount').textContent;
            const token = TOKEN_SYMBOL;

            const systemPrompt = `You are a professional communications assistant. Draft a short, formal email (max 3 paragraphs) to submit an airdrop claim. The email must be polite, assertive, and include the wallet address and allocation amount. Do not include a subject line or closing salutation.`;

            const userQuery = `Draft a claim letter for an airdrop allocation of ${allocated} ${token} for the wallet address: ${address}.`;
            
            callGemini(systemPrompt, userQuery, 'llmText', 'draftButton');
        }

        // Initialization: Hide LLM output on load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('llmOutput').classList.add('hidden');
        });
    </script>
</body>
</html>
