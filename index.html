<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASE Protocol Airdrop Allocation Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Dark background for professional look */
        }
        .container-bg {
            background-color: #121212;
        }
        .text-base {
            color: #0052FF; /* BASE Blue */
        }
        .btn-primary {
            background-color: #0052FF;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #003ECC;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 82, 255, 0.4);
        }
        .input-text {
            border: 2px solid #333;
            background-color: #1F1F1F;
            color: white;
            transition: border-color 0.2s;
        }
        .input-text:focus {
            border-color: #0052FF;
            outline: none;
        }
        .result-box {
            border-radius: 1rem;
            border: 2px solid #0052FF;
            background-color: #0a0a0a;
            box-shadow: 0 0 20px rgba(0, 82, 255, 0.2);
        }
    </style>

    <!-- Farcaster Frame Meta Tags (Adjusted to Vercel URL) -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://placehold.co/1200x630/0052FF/ffffff?text=BASE+x+ETH+Airdrop+Checker" />
    <meta property="fc:frame:button:1" content="Check Allocation Now" />
    <meta property="fc:frame:post_url" content="https://base-checker-airdrop.vercel.app/" />
    <!-- End Farcaster Frame Meta Tags -->
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="container-bg w-full max-w-lg mx-auto p-6 md:p-10 rounded-xl shadow-2xl border border-gray-800">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2">
                <span class="text-base">BASE</span> Protocol Airdrop
            </h1>
            <p class="text-gray-400 text-lg">Allocation Portal</p>
        </header>

        <main>
            <div class="mb-6">
                <label for="walletAddress" class="block text-sm font-medium text-gray-300 mb-2">
                    Masukkan Alamat Dompet ETH / BASE (0x...)
                </label>
                <input type="text" id="walletAddress" placeholder="Contoh: 0xAb5801..." class="input-text w-full p-3 rounded-lg text-lg focus:ring-2 focus:ring-base" maxlength="42">
                <p id="addressError" class="text-red-500 text-sm mt-1 h-5"></p>
            </div>

            <button onclick="checkAirdrop()" id="checkButton" class="btn-primary w-full text-white font-bold py-3 rounded-lg text-xl tracking-wider">
                Verifikasi & Cek Alokasi
            </button>

            <div id="loadingIndicator" class="mt-6 text-center hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-base border-t-transparent rounded-full"></div>
                <p class="text-gray-400 mt-2">Memverifikasi interaksi on-chain...</p>
            </div>

            <!-- Result Box -->
            <div id="resultContainer" class="mt-8 result-box p-6 hidden">
                <h2 class="text-xl font-bold mb-3 text-white">Status Verifikasi:</h2>
                <p id="eligibilityStatus" class="text-2xl font-extrabold mb-4"></p>
                <div id="allocationDetails" class="space-y-1 text-gray-300 border-t border-gray-700 pt-3">
                    <p>Alokasi Token: <span id="allocatedAmount" class="font-bold text-lg text-base ml-1"></span></p>
                    <p>Metode Klaim: <span class="font-bold text-green-400">Smart Contract Claim (TBD)</span></p>
                    <p class="text-sm text-gray-500 mt-3">Catatan: Data ini disimulasikan dan unik per alamat dompet.</p>
                </div>

                <!-- LLM Features -->
                <div class="mt-6 space-y-3">
                    <button onclick="analyzeDefiProfile()" id="analyzeButton" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-600 transition duration-150">
                        <span>✨ Analisis Profil DeFi (Oleh Gemini AI)</span>
                    </button>
                    <button onclick="draftClaimLetter()" id="draftButton" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-600 transition duration-150">
                        <span>✉️ Draf Surat Klaim (Oleh Gemini AI)</span>
                    </button>
                </div>

                <!-- LLM Output -->
                <div id="llmOutput" class="mt-6 p-4 bg-gray-800 rounded-lg text-sm text-gray-200 hidden">
                    <h3 class="font-bold mb-2 text-base">Hasil Analisis AI:</h3>
                    <div id="llmText"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const apiKey = ""; // Disediakan oleh Canvas
        const TOKEN_SYMBOL = "$BASE";

        // Fungsi utilitas untuk menghasilkan kode hash yang konsisten dari string
        function hashCode(s) {
            let hash = 0;
            for (let i = 0; i < s.length; i++) {
                const char = s.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // Fungsi utama untuk memverifikasi dan menampilkan alokasi
        function checkAirdrop() {
            const addressInput = document.getElementById('walletAddress');
            const address = addressInput.value.trim();
            const errorElement = document.getElementById('addressError');
            const resultContainer = document.getElementById('resultContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const eligibilityStatus = document.getElementById('eligibilityStatus');
            const allocatedAmount = document.getElementById('allocatedAmount');
            const llmOutput = document.getElementById('llmOutput');

            // Reset tampilan
            resultContainer.classList.add('hidden');
            llmOutput.classList.add('hidden');
            errorElement.textContent = '';
            document.getElementById('llmText').innerHTML = '';

            // Validasi format alamat
            if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
                errorElement.textContent = 'Format alamat tidak valid. Harus dimulai dengan 0x dan 42 karakter.';
                return;
            }

            // Tampilkan loading
            loadingIndicator.classList.remove('hidden');
            document.getElementById('checkButton').disabled = true;

            // Simulasi penundaan
            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                document.getElementById('checkButton').disabled = false;

                // 1. Tentukan kelayakan (Selalu eligible berdasarkan permintaan)
                const isEligible = true;

                // 2. Hitung Alokasi Fiktif yang Konsisten
                const baseHash = hashCode(address);
                const allocationBase = 5000;
                const allocationBonus = (baseHash % 1000) * 10; // Bonus hingga 10,000 token
                const finalAllocation = allocationBase + allocationBonus;

                if (isEligible) {
                    eligibilityStatus.textContent = 'ELIGIBILITY CONFIRMED (Level A)';
                    eligibilityStatus.classList.remove('text-red-500');
                    eligibilityStatus.classList.add('text-green-500');

                    allocatedAmount.textContent = `${finalAllocation.toLocaleString('en-US')} ${TOKEN_SYMBOL}`;
                } else {
                    // Logika ini dinonaktifkan per permintaan pengguna (semua eligible)
                }

                resultContainer.classList.remove('hidden');
            }, 1500);
        }

        // Fungsi untuk memanggil Gemini API
        async function callGemini(systemPrompt, userQuery, outputElementId, buttonId) {
            const outputElement = document.getElementById(outputElementId);
            const button = document.getElementById(buttonId);
            const llmOutputContainer = document.getElementById('llmOutput');

            button.disabled = true;
            button.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Loading...';
            outputElement.innerHTML = '';
            llmOutputContainer.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const url = `${API_URL}${apiKey}`;

            try {
                // Implementasi exponential backoff
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (i < 2) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error('Gagal terhubung ke API setelah beberapa kali coba.');
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal mendapatkan respons dari AI.";
                outputElement.innerHTML = formatLLMText(text);

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputElement.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                button.disabled = false;
                if (buttonId === 'analyzeButton') {
                    button.innerHTML = '<span>✨ Analisis Profil DeFi (Oleh Gemini AI)</span>';
                } else if (buttonId === 'draftButton') {
                    button.innerHTML = '<span>✉️ Draf Surat Klaim (Oleh Gemini AI)</span>';
                }
            }
        }

        // Fungsi utilitas untuk memformat teks LLM (misalnya, membuat paragraf)
        function formatLLMText(text) {
            // Mengganti baris baru ganda dengan tag paragraf untuk tampilan yang lebih baik
            return text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')
                       .replace(/(\*+)(.*?)\1/g, '<strong>$2</strong>'); // Sederhana: bold
        }

        // Fitur 1: Analisis Profil DeFi
        function analyzeDefiProfile() {
            const address = document.getElementById('walletAddress').value.trim();
            const allocated = document.getElementById('allocatedAmount').textContent;

            const systemPrompt = `Anda adalah analis on-chain yang sangat berpengalaman dan profesional. Tugas Anda adalah menganalisis alamat dompet Ethereum/BASE yang diberikan. Berikan ringkasan fiktif yang meyakinkan tentang aktivitas DeFi alamat tersebut dalam satu paragraf yang solid dan profesional. Fokus pada interaksi fiktif dengan swap, bridge, atau governance BASE. Jangan menyebutkan bahwa ini fiktif.`;
            
            const userQuery = `Berdasarkan alokasi ${allocated} token, analisis profil DeFi untuk alamat ini: ${address}.`;

            callGemini(systemPrompt, userQuery, 'llmText', 'analyzeButton');
        }

        // Fitur 2: Draf Surat Klaim
        function draftClaimLetter() {
            const address = document.getElementById('walletAddress').value.trim();
            const allocated = document.getElementById('allocatedAmount').textContent;
            const token = TOKEN_SYMBOL;

            const systemPrompt = `Anda adalah asisten komunikasi profesional. Buatkan draf email singkat dan formal (maksimal 3 paragraf) untuk mengirimkan klaim airdrop. Email harus bernada sopan, tegas, dan menyertakan alamat dompet dan jumlah alokasi. Jangan sertakan subjek atau salam penutup.`;

            const userQuery = `Buatkan draf surat klaim untuk alokasi airdrop sebesar ${allocated} ${token} untuk alamat dompet: ${address}.`;
            
            callGemini(systemPrompt, userQuery, 'llmText', 'draftButton');
        }

        // Inisialisasi: Sembunyikan LLM output saat pertama kali dimuat
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('llmOutput').classList.add('hidden');
        });
    </script>
</body>
</html>
